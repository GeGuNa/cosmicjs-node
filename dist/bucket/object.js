"use strict";

var _require = require('../helpers/constants'),
    URI = _require.URI;

var HTTP_METHODS = require('../helpers/http_methods');

var _require2 = require('../helpers/request_handler'),
    requestHandler = _require2.requestHandler;

var headers;

var addParamsToObjectsEndpoint = function addParamsToObjectsEndpoint(endpoint, params) {
  if (params && params.limit) {
    endpoint += "&limit=".concat(params.limit);
  }

  if (params && params.skip) {
    endpoint += "&skip=".concat(params.skip);
  }

  if (params && params.status) {
    endpoint += "&status=".concat(params.status);
  }

  if (params && params.after) {
    endpoint += "&after=".concat(params.after);
  }

  if (params && params.sort) {
    endpoint += "&sort=".concat(params.sort);
  }

  if (params && params.show_metafields) {
    endpoint += "&show_metafields=".concat(params.show_metafields);
  }

  if (params && params.pretty) {
    endpoint += "&pretty=".concat(params.pretty);
  }

  if (params && params.props) {
    endpoint += "&props=".concat(params.props);
  }

  if (params && params.query) {
    endpoint += "&query=".concat(encodeURI(JSON.stringify(params.query)));
  }

  if (params && typeof params.use_cache !== 'undefined') {
    endpoint += "&use_cache=".concat(params.use_cache);
  }

  return endpoint;
};

var objectMethods = function objectMethods(bucket_config) {
  return {
    getObjects: function getObjects(params) {
      var endpoint = "".concat(URI, "/buckets/").concat(bucket_config.slug, "/objects?read_key=").concat(bucket_config.read_key);
      endpoint = addParamsToObjectsEndpoint(endpoint, params);
      return requestHandler(HTTP_METHODS.GET, endpoint);
    },
    getObject: function getObject(params) {
      if (!params) {
        throw new Error('Must supply params object with object id');
      }

      var endpoint = "".concat(URI, "/buckets/").concat(bucket_config.slug, "/objects/").concat(params.id, "?read_key=").concat(bucket_config.read_key);

      if (params && params.status) {
        endpoint += "&status=".concat(params.status);
      }

      if (params && params.props) {
        endpoint += "&props=".concat(params.props);
      }

      if (params && typeof params.use_cache !== 'undefined') {
        endpoint += "&use_cache=".concat(params.use_cache);
      }

      return requestHandler(HTTP_METHODS.GET, endpoint);
    },
    getObjectRevisions: function getObjectRevisions(params) {
      var endpoint = "".concat(URI, "/buckets/").concat(bucket_config.slug, "/objects/").concat(params.id, "/revisions?read_key=").concat(bucket_config.read_key);
      endpoint = addParamsToObjectsEndpoint(endpoint, params);
      return requestHandler(HTTP_METHODS.GET, endpoint);
    },
    getMergeRequestObjects: function getMergeRequestObjects(params) {
      var endpoint = "".concat(URI, "/buckets/").concat(bucket_config.slug, "/merge-requests/").concat(params.id, "/objects?read_key=").concat(bucket_config.read_key);
      endpoint = addParamsToObjectsEndpoint(endpoint, params);
      return requestHandler(HTTP_METHODS.GET, endpoint);
    },
    addObject: function addObject(params) {
      var endpoint = "".concat(URI, "/buckets/").concat(bucket_config.slug, "/objects");

      if (bucket_config.write_key) {
        headers = {
          "Authorization": "Bearer ".concat(bucket_config.write_key)
        };
      }

      return requestHandler(HTTP_METHODS.POST, endpoint, params, headers);
    },
    addObjectRevision: function addObjectRevision(params) {
      var endpoint = "".concat(URI, "/buckets/").concat(bucket_config.slug, "/objects/").concat(params.id, "/revisions");
      delete params.id;
      delete params.type;

      if (bucket_config.write_key) {
        headers = {
          "Authorization": "Bearer ".concat(bucket_config.write_key)
        };
      }

      return requestHandler(HTTP_METHODS.POST, endpoint, params, headers);
    },
    editObject: function editObject(params) {
      var endpoint = "".concat(URI, "/buckets/").concat(bucket_config.slug, "/objects/").concat(params.id);

      if (bucket_config.write_key) {
        headers = {
          "Authorization": "Bearer ".concat(bucket_config.write_key)
        };
      } // Remove id


      delete params.id;
      return requestHandler(HTTP_METHODS.PATCH, endpoint, params, headers);
    },
    editObjectMetafields: function editObjectMetafields(params) {
      var endpoint = "".concat(URI, "/buckets/").concat(bucket_config.slug, "/objects/").concat(params.id, "/metafields");

      if (bucket_config.write_key) {
        headers = {
          "Authorization": "Bearer ".concat(bucket_config.write_key)
        };
      } // Remove id


      delete params.id;
      return requestHandler(HTTP_METHODS.PATCH, endpoint, params, headers);
    },
    deleteObject: function deleteObject(params) {
      var endpoint = "".concat(URI, "/buckets/").concat(bucket_config.slug, "/objects/").concat(params.id);

      if (bucket_config.write_key) {
        headers = {
          "Authorization": "Bearer ".concat(bucket_config.write_key)
        };
      }

      return requestHandler(HTTP_METHODS.DELETE, endpoint, null, headers);
    }
  };
};

module.exports = objectMethods;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9idWNrZXQvb2JqZWN0LmpzIl0sIm5hbWVzIjpbInJlcXVpcmUiLCJVUkkiLCJIVFRQX01FVEhPRFMiLCJyZXF1ZXN0SGFuZGxlciIsImhlYWRlcnMiLCJhZGRQYXJhbXNUb09iamVjdHNFbmRwb2ludCIsImVuZHBvaW50IiwicGFyYW1zIiwibGltaXQiLCJza2lwIiwic3RhdHVzIiwiYWZ0ZXIiLCJzb3J0Iiwic2hvd19tZXRhZmllbGRzIiwicHJldHR5IiwicHJvcHMiLCJxdWVyeSIsImVuY29kZVVSSSIsIkpTT04iLCJzdHJpbmdpZnkiLCJ1c2VfY2FjaGUiLCJvYmplY3RNZXRob2RzIiwiYnVja2V0X2NvbmZpZyIsImdldE9iamVjdHMiLCJzbHVnIiwicmVhZF9rZXkiLCJHRVQiLCJnZXRPYmplY3QiLCJFcnJvciIsImlkIiwiZ2V0T2JqZWN0UmV2aXNpb25zIiwiZ2V0TWVyZ2VSZXF1ZXN0T2JqZWN0cyIsImFkZE9iamVjdCIsIndyaXRlX2tleSIsIlBPU1QiLCJhZGRPYmplY3RSZXZpc2lvbiIsInR5cGUiLCJlZGl0T2JqZWN0IiwiUEFUQ0giLCJlZGl0T2JqZWN0TWV0YWZpZWxkcyIsImRlbGV0ZU9iamVjdCIsIkRFTEVURSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O2VBQWdCQSxPQUFPLENBQUMsc0JBQUQsQztJQUFmQyxHLFlBQUFBLEc7O0FBQ1IsSUFBTUMsWUFBWSxHQUFHRixPQUFPLENBQUMseUJBQUQsQ0FBNUI7O2dCQUMyQkEsT0FBTyxDQUFDLDRCQUFELEM7SUFBMUJHLGMsYUFBQUEsYzs7QUFDUixJQUFJQyxPQUFKOztBQUVBLElBQU1DLDBCQUEwQixHQUFHLFNBQTdCQSwwQkFBNkIsQ0FBQ0MsUUFBRCxFQUFXQyxNQUFYLEVBQXNCO0FBQ3ZELE1BQUlBLE1BQU0sSUFBSUEsTUFBTSxDQUFDQyxLQUFyQixFQUE0QjtBQUMxQkYsSUFBQUEsUUFBUSxxQkFBY0MsTUFBTSxDQUFDQyxLQUFyQixDQUFS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RCxRQUFRLGFBQU1MLEdBQU4sc0JBQXFCcUIsYUFBYSxDQUFDRSxJQUFuQyxzQkFBbURqQixNQUFNLENBQUNzQixFQUExRCxnQkFBZDs7QUFDQSxVQUFJUCxhQUFhLENBQUNXLFNBQWxCLEVBQTZCO0FBQzNCN0IsUUFBQUEsT0FBTyxHQUFHO0FBQ1IsNENBQTJCa0IsYUFBYSxDQUFDVyxTQUF6QztBQURRLFNBQVY7QUFHRCxPQU4rQixDQU9oQzs7O0FBQ0EsYUFBTzFCLE1BQU0sQ0FBQ3NCLEVBQWQ7QUFDQSxhQUFPMUIsY0FBYyxDQUFDRCxZQUFZLENBQUNvQyxLQUFkLEVBQXFCaEMsUUFBckIsRUFBK0JDLE1BQS9CLEVBQXVDSCxPQUF2QyxDQUFyQjtBQUNELEtBekV1QztBQTBFeENvQyxJQUFBQSxZQUFZLEVBQUUsc0JBQUNqQyxNQUFELEVBQVk7QUFDeEIsVUFBTUQsUUFBUSxhQUFNTCxHQUFOLHNCQUFxQnFCLGFBQWEsQ0FBQ0UsSUFBbkMsc0JBQW1EakIsTUFBTSxDQUFDc0IsRUFBMUQsQ0FBZDs7QUFDQSxVQUFJUCxhQUFhLENBQUNXLFNBQWxCLEVBQTZCO0FBQzNCN0IsUUFBQUEsT0FBTyxHQUFHO0FBQ1IsNENBQTJCa0IsYUFBYSxDQUFDVyxTQUF6QztBQURRLFNBQVY7QUFHRDs7QUFDRCxhQUFPOUIsY0FBYyxDQUFDRCxZQUFZLENBQUN1QyxNQUFkLEVBQXNCbkMsUUFBdEIsRUFBZ0MsSUFBaEMsRUFBc0NGLE9BQXRDLENBQXJCO0FBQ0Q7QUFsRnVDLEdBQXBCO0FBQUEsQ0FBdEI7O0FBcUZBc0MsTUFBTSxDQUFDQyxPQUFQLEdBQWlCdEIsYUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IFVSSSB9ID0gcmVxdWlyZSgnLi4vaGVscGVycy9jb25zdGFudHMnKVxuY29uc3QgSFRUUF9NRVRIT0RTID0gcmVxdWlyZSgnLi4vaGVscGVycy9odHRwX21ldGhvZHMnKVxuY29uc3QgeyByZXF1ZXN0SGFuZGxlciB9ID0gcmVxdWlyZSgnLi4vaGVscGVycy9yZXF1ZXN0X2hhbmRsZXInKVxubGV0IGhlYWRlcnM7XG5cbmNvbnN0IGFkZFBhcmFtc1RvT2JqZWN0c0VuZHBvaW50ID0gKGVuZHBvaW50LCBwYXJhbXMpID0+IHtcbiAgaWYgKHBhcmFtcyAmJiBwYXJhbXMubGltaXQpIHtcbiAgICBlbmRwb2ludCArPSBgJmxpbWl0PSR7cGFyYW1zLmxpbWl0fWBcbiAgfVxuICBpZiAocGFyYW1zICYmIHBhcmFtcy5za2lwKSB7XG4gICAgZW5kcG9pbnQgKz0gYCZza2lwPSR7cGFyYW1zLnNraXB9YFxuICB9XG4gIGlmIChwYXJhbXMgJiYgcGFyYW1zLnN0YXR1cykge1xuICAgIGVuZHBvaW50ICs9IGAmc3RhdHVzPSR7cGFyYW1zLnN0YXR1c31gXG4gIH1cbiAgaWYgKHBhcmFtcyAmJiBwYXJhbXMuYWZ0ZXIpIHtcbiAgICBlbmRwb2ludCArPSBgJmFmdGVyPSR7cGFyYW1zLmFmdGVyfWBcbiAgfVxuICBpZiAocGFyYW1zICYmIHBhcmFtcy5zb3J0KSB7XG4gICAgZW5kcG9pbnQgKz0gYCZzb3J0PSR7cGFyYW1zLnNvcnR9YFxuICB9XG4gIGlmIChwYXJhbXMgJiYgcGFyYW1zLnNob3dfbWV0YWZpZWxkcykge1xuICAgIGVuZHBvaW50ICs9IGAmc2hvd19tZXRhZmllbGRzPSR7cGFyYW1zLnNob3dfbWV0YWZpZWxkc31gXG4gIH1cbiAgaWYgKHBhcmFtcyAmJiBwYXJhbXMucHJldHR5KSB7XG4gICAgZW5kcG9pbnQgKz0gYCZwcmV0dHk9JHtwYXJhbXMucHJldHR5fWBcbiAgfVxuICBpZiAocGFyYW1zICYmIHBhcmFtcy5wcm9wcykge1xuICAgIGVuZHBvaW50ICs9IGAmcHJvcHM9JHtwYXJhbXMucHJvcHN9YFxuICB9XG4gIGlmIChwYXJhbXMgJiYgcGFyYW1zLnF1ZXJ5KSB7XG4gICAgZW5kcG9pbnQgKz0gYCZxdWVyeT0ke2VuY29kZVVSSShKU09OLnN0cmluZ2lmeShwYXJhbXMucXVlcnkpKX1gXG4gIH1cbiAgaWYgKHBhcmFtcyAmJiB0eXBlb2YgcGFyYW1zLnVzZV9jYWNoZSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICBlbmRwb2ludCArPSBgJnVzZV9jYWNoZT0ke3BhcmFtcy51c2VfY2FjaGV9YFxuICB9XG4gIHJldHVybiBlbmRwb2ludFxufVxuXG5jb25zdCBvYmplY3RNZXRob2RzID0gKGJ1Y2tldF9jb25maWcpID0+ICh7XG4gIGdldE9iamVjdHM6IChwYXJhbXMpID0+IHtcbiAgICBsZXQgZW5kcG9pbnQgPSBgJHtVUkl9L2J1Y2tldHMvJHtidWNrZXRfY29uZmlnLnNsdWd9L29iamVjdHM/cmVhZF9rZXk9JHtidWNrZXRfY29uZmlnLnJlYWRfa2V5fWBcbiAgICBlbmRwb2ludCA9IGFkZFBhcmFtc1RvT2JqZWN0c0VuZHBvaW50KGVuZHBvaW50LCBwYXJhbXMpXG4gICAgcmV0dXJuIHJlcXVlc3RIYW5kbGVyKEhUVFBfTUVUSE9EUy5HRVQsIGVuZHBvaW50KVxuICB9LFxuICBnZXRPYmplY3Q6IChwYXJhbXMpID0+IHtcbiAgICBpZiAoIXBhcmFtcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdNdXN0IHN1cHBseSBwYXJhbXMgb2JqZWN0IHdpdGggb2JqZWN0IGlkJylcbiAgICB9XG4gICAgbGV0IGVuZHBvaW50ID0gYCR7VVJJfS9idWNrZXRzLyR7YnVja2V0X2NvbmZpZy5zbHVnfS9vYmplY3RzLyR7cGFyYW1zLmlkfT9yZWFkX2tleT0ke2J1Y2tldF9jb25maWcucmVhZF9rZXl9YFxuICAgIGlmIChwYXJhbXMgJiYgcGFyYW1zLnN0YXR1cykge1xuICAgICAgZW5kcG9pbnQgKz0gYCZzdGF0dXM9JHtwYXJhbXMuc3RhdHVzfWBcbiAgICB9XG4gICAgaWYgKHBhcmFtcyAmJiBwYXJhbXMucHJvcHMpIHtcbiAgICAgIGVuZHBvaW50ICs9IGAmcHJvcHM9JHtwYXJhbXMucHJvcHN9YFxuICAgIH1cbiAgICBpZiAocGFyYW1zICYmIHR5cGVvZiBwYXJhbXMudXNlX2NhY2hlICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgZW5kcG9pbnQgKz0gYCZ1c2VfY2FjaGU9JHtwYXJhbXMudXNlX2NhY2hlfWBcbiAgICB9XG4gICAgcmV0dXJuIHJlcXVlc3RIYW5kbGVyKEhUVFBfTUVUSE9EUy5HRVQsIGVuZHBvaW50KVxuICB9LFxuICBnZXRPYmplY3RSZXZpc2lvbnM6IChwYXJhbXMpID0+IHtcbiAgICBsZXQgZW5kcG9pbnQgPSBgJHtVUkl9L2J1Y2tldHMvJHtidWNrZXRfY29uZmlnLnNsdWd9L29iamVjdHMvJHtwYXJhbXMuaWR9L3JldmlzaW9ucz9yZWFkX2tleT0ke2J1Y2tldF9jb25maWcucmVhZF9rZXl9YFxuICAgIGVuZHBvaW50ID0gYWRkUGFyYW1zVG9PYmplY3RzRW5kcG9pbnQoZW5kcG9pbnQsIHBhcmFtcylcbiAgICByZXR1cm4gcmVxdWVzdEhhbmRsZXIoSFRUUF9NRVRIT0RTLkdFVCwgZW5kcG9pbnQpXG4gIH0sXG4gIGdldE1lcmdlUmVxdWVzdE9iamVjdHM6IChwYXJhbXMpID0+IHtcbiAgICBsZXQgZW5kcG9pbnQgPSBgJHtVUkl9L2J1Y2tldHMvJHtidWNrZXRfY29uZmlnLnNsdWd9L21lcmdlLXJlcXVlc3RzLyR7cGFyYW1zLmlkfS9vYmplY3RzP3JlYWRfa2V5PSR7YnVja2V0X2NvbmZpZy5yZWFkX2tleX1gXG4gICAgZW5kcG9pbnQgPSBhZGRQYXJhbXNUb09iamVjdHNFbmRwb2ludChlbmRwb2ludCwgcGFyYW1zKVxuICAgIHJldHVybiByZXF1ZXN0SGFuZGxlcihIVFRQX01FVEhPRFMuR0VULCBlbmRwb2ludClcbiAgfSxcbiAgYWRkT2JqZWN0OiAocGFyYW1zKSA9PiB7XG4gICAgY29uc3QgZW5kcG9pbnQgPSBgJHtVUkl9L2J1Y2tldHMvJHtidWNrZXRfY29uZmlnLnNsdWd9L29iamVjdHNgXG4gICAgaWYgKGJ1Y2tldF9jb25maWcud3JpdGVfa2V5KSB7XG4gICAgICBoZWFkZXJzID0ge1xuICAgICAgICBcIkF1dGhvcml6YXRpb25cIjogYEJlYXJlciAke2J1Y2tldF9jb25maWcud3JpdGVfa2V5fWBcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlcXVlc3RIYW5kbGVyKEhUVFBfTUVUSE9EUy5QT1NULCBlbmRwb2ludCwgcGFyYW1zLCBoZWFkZXJzKVxuICB9LFxuICBhZGRPYmplY3RSZXZpc2lvbjogKHBhcmFtcykgPT4ge1xuICAgIGNvbnN0IGVuZHBvaW50ID0gYCR7VVJJfS9idWNrZXRzLyR7YnVja2V0X2NvbmZpZy5zbHVnfS9vYmplY3RzLyR7cGFyYW1zLmlkfS9yZXZpc2lvbnNgXG4gICAgZGVsZXRlIHBhcmFtcy5pZFxuICAgIGRlbGV0ZSBwYXJhbXMudHlwZVxuICAgIGlmIChidWNrZXRfY29uZmlnLndyaXRlX2tleSkge1xuICAgICAgaGVhZGVycyA9IHtcbiAgICAgICAgXCJBdXRob3JpemF0aW9uXCI6IGBCZWFyZXIgJHtidWNrZXRfY29uZmlnLndyaXRlX2tleX1gXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXF1ZXN0SGFuZGxlcihIVFRQX01FVEhPRFMuUE9TVCwgZW5kcG9pbnQsIHBhcmFtcywgaGVhZGVycylcbiAgfSxcbiAgZWRpdE9iamVjdDogKHBhcmFtcykgPT4ge1xuICAgIGNvbnN0IGVuZHBvaW50ID0gYCR7VVJJfS9idWNrZXRzLyR7YnVja2V0X2NvbmZpZy5zbHVnfS9vYmplY3RzLyR7cGFyYW1zLmlkfWBcbiAgICBpZiAoYnVja2V0X2NvbmZpZy53cml0ZV9rZXkpIHtcbiAgICAgIGhlYWRlcnMgPSB7XG4gICAgICAgIFwiQXV0aG9yaXphdGlvblwiOiBgQmVhcmVyICR7YnVja2V0X2NvbmZpZy53cml0ZV9rZXl9YFxuICAgICAgfVxuICAgIH1cbiAgICAvLyBSZW1vdmUgaWRcbiAgICBkZWxldGUgcGFyYW1zLmlkO1xuICAgIHJldHVybiByZXF1ZXN0SGFuZGxlcihIVFRQX01FVEhPRFMuUEFUQ0gsIGVuZHBvaW50LCBwYXJhbXMsIGhlYWRlcnMpXG4gIH0sXG4gIGVkaXRPYmplY3RNZXRhZmllbGRzOiAocGFyYW1zKSA9PiB7XG4gICAgY29uc3QgZW5kcG9pbnQgPSBgJHtVUkl9L2J1Y2tldHMvJHtidWNrZXRfY29uZmlnLnNsdWd9L29iamVjdHMvJHtwYXJhbXMuaWR9L21ldGFmaWVsZHNgXG4gICAgaWYgKGJ1Y2tldF9jb25maWcud3JpdGVfa2V5KSB7XG4gICAgICBoZWFkZXJzID0ge1xuICAgICAgICBcIkF1dGhvcml6YXRpb25cIjogYEJlYXJlciAke2J1Y2tldF9jb25maWcud3JpdGVfa2V5fWBcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gUmVtb3ZlIGlkXG4gICAgZGVsZXRlIHBhcmFtcy5pZDtcbiAgICByZXR1cm4gcmVxdWVzdEhhbmRsZXIoSFRUUF9NRVRIT0RTLlBBVENILCBlbmRwb2ludCwgcGFyYW1zLCBoZWFkZXJzKVxuICB9LFxuICBkZWxldGVPYmplY3Q6IChwYXJhbXMpID0+IHtcbiAgICBjb25zdCBlbmRwb2ludCA9IGAke1VSSX0vYnVja2V0cy8ke2J1Y2tldF9jb25maWcuc2x1Z30vb2JqZWN0cy8ke3BhcmFtcy5pZH1gXG4gICAgaWYgKGJ1Y2tldF9jb25maWcud3JpdGVfa2V5KSB7XG4gICAgICBoZWFkZXJzID0ge1xuICAgICAgICBcIkF1dGhvcml6YXRpb25cIjogYEJlYXJlciAke2J1Y2tldF9jb25maWcud3JpdGVfa2V5fWBcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlcXVlc3RIYW5kbGVyKEhUVFBfTUVUSE9EUy5ERUxFVEUsIGVuZHBvaW50LCBudWxsLCBoZWFkZXJzKVxuICB9XG59KVxuXG5tb2R1bGUuZXhwb3J0cyA9IG9iamVjdE1ldGhvZHNcbiJdfQ==